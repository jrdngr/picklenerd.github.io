<!DOCTYPE html>
<html>

<head>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>
        picklenerd
    </title>

    

<link id="darkly" class="stylesheet" rel="stylesheet"
    href="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;darkly.css" />


    <!-- This script must follow css -->
    
    <script type="text/javascript" src="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;js&#x2F;zulma_switchcss.js"></script>
    <script>
        switch_css.init("https://picklenerd.github.io");
    </script>
    

    

    
    <script defer type="text/javascript" src="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;elasticlunr.min.js"></script>
    <script defer type="text/javascript" src="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;search_index.en.js"></script>
    

    
    

    <noscript>
        <style>
            .navbar-menu {
                display: block;
            }

            .js-only {
                display: none;
            }
        </style>
    </noscript>
    
</head>

<body>
    
    
<!-- START NAV -->


    

<header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                
                <span class="navbar-burger burger" data-target="navbarMenu">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </div>
            <div id="navbarMenu" class="navbar-menu">
                <div class="navbar-end">
                    
                    
                    
                    
                    <a itemprop="url"
                        class="navbar-item "
                        href="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;tags">
                        <span itemprop="name">Tags
                        </span>
                    </a>
                    
                    

                    
                    <div class="navbar-item search-container js-only">
                        <input class="input" id="search" type="search" placeholder="Search">

                        <div class="search-results box">
                            <div class="search-results__items"></div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </nav>
</header>


    

<!-- END NAV -->
<main>
    <section class="container">
        <div class="columns is-desktop">
            <div class="column is-10-desktop is-offset-1-desktop">
                <article itemscope itemtype="http://schema.org/BlogPosting">
                    <div class="card article">
                        <div class="card-content">
                            
<header>
    <div class="has-text-centered">
        <a href="https://picklenerd.github.io/creature-discomfort/">
            <p class="title article-title">Learning Rust 6: Creature Discomfort
            </p>
        </a>
        <div class="tags has-addons level-item">
            <span class="tag is-rounded">2017-07-15</span>
                       
            <span class="tag is-rounded">
<svg class="i-clock" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round"
    stroke-linejoin="round" stroke-width="6.25%">
    <circle cx="16" cy="16" r="14" />
    <path d="M16 8 L16 16 20 20" />
</svg>
<span>&nbsp;3 minute read</span>
</span>
        </div>
    </div>
</header>

                            <div itemprop="articleBody" class="content article-body">
                                <p>I'm finally settling into a creature design.  I've tried several other setups, but I still like having a generic creature struct with a function pointer for behavior.  It fits well with the two roles that a creature has to fill, storing information about its state, and determining what to do next time it gets a turn.  Any properties specific to that creature are stored in its <code>properties</code> HashMap.</p>
<p>This is how the plant is currently defined.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">new</span><span style="color:#c0c5ce;">() -&gt; Creature {
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> properties: HashMap&lt;String, Property&gt; = HashMap::new();
    properties.</span><span style="color:#96b5b4;">insert</span><span style="color:#c0c5ce;">(String::from(</span><span style="color:#d08770;">ENERGY_PER_TICK</span><span style="color:#c0c5ce;">), Property::Integer(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">));
    properties.</span><span style="color:#96b5b4;">insert</span><span style="color:#c0c5ce;">(String::from(</span><span style="color:#d08770;">ENERGY_TO_SPLIT</span><span style="color:#c0c5ce;">), Property::Integer(</span><span style="color:#d08770;">100</span><span style="color:#c0c5ce;">));
    
    Creature {
        creature_type: CreatureType::Plant,
        color: [</span><span style="color:#d08770;">0.0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0.5</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0.0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1.0</span><span style="color:#c0c5ce;">],
        energy: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
        sleep: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,
        properties: properties,
        action: plant_action,
    }
}

</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">plant_action</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">myself</span><span style="color:#c0c5ce;">: &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> Creature, </span><span style="color:#bf616a;">neighbors</span><span style="color:#c0c5ce;">: &amp;Neighbors) -&gt; Vec&lt;Action&gt; {

    </span><span style="color:#b48ead;">let </span><span style="color:#c0c5ce;">(energy_per_tick, energy_to_split) = </span><span style="color:#96b5b4;">get_variables</span><span style="color:#c0c5ce;">(&amp;myself.properties);

    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> myself.energy &lt; energy_to_split {
        </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">random_percentage</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">) {
            myself.energy += energy_per_tick * </span><span style="color:#96b5b4;">random_int</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">);
        }
        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">vec![Action::Idle, Action::Queue(neighbors.</span><span style="color:#96b5b4;">pos</span><span style="color:#c0c5ce;">())];
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> empty_neighbors = neighbors.</span><span style="color:#96b5b4;">of_type</span><span style="color:#c0c5ce;">(CreatureType::Empty);
        </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> empty_neighbors.</span><span style="color:#96b5b4;">is_empty</span><span style="color:#c0c5ce;">() {
            </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">vec![Action::Idle];
        }
        </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> new_index = </span><span style="color:#96b5b4;">random_index</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, empty_neighbors.</span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">());
        </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> new_pos = empty_neighbors[new_index].</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;

        vec![Action::Set(new_pos, </span><span style="color:#96b5b4;">get</span><span style="color:#c0c5ce;">(CreatureType::Plant)), Action::Queue(neighbors.</span><span style="color:#96b5b4;">pos</span><span style="color:#c0c5ce;">())]
    }
}

</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">get_variables</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">properties</span><span style="color:#c0c5ce;">: &amp;HashMap&lt;String, Property&gt;) -&gt; (</span><span style="color:#b48ead;">i64</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">i64</span><span style="color:#c0c5ce;">) {
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> energy_per_tick: </span><span style="color:#b48ead;">i64 </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> properties.</span><span style="color:#96b5b4;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">ENERGY_PER_TICK</span><span style="color:#c0c5ce;">) {
        Some(&amp;Property::Integer(n)) =&gt; n,
        _ =&gt; </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">,
    };
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> energy_to_split = </span><span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> properties.</span><span style="color:#96b5b4;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">ENERGY_PER_TICK</span><span style="color:#c0c5ce;">){
        Some(&amp;Property::Integer(n)) =&gt; n,
        _ =&gt; </span><span style="color:#d08770;">100</span><span style="color:#c0c5ce;">,
    };

    (energy_per_tick, energy_to_split)
}
</span></code></pre>
<p><code>get_variables</code> is pulled out to keep the action method a bit cleaner.  I think I can come up with a much better way to get these variables.  The main issue is that I don't know which <code>Property</code> variation a given property is going to have.  I have two thoughts about this.  One is that I might be able to make a macro that handles this cleanly, but I'm not ready to dive into macros yet.  The other is to make every property an <code>f64</code>.  The <code>Property</code> enum currently looks like this:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">pub enum </span><span style="color:#c0c5ce;">Property {
    Integer(</span><span style="color:#b48ead;">i64</span><span style="color:#c0c5ce;">),
    Decimal(</span><span style="color:#b48ead;">f64</span><span style="color:#c0c5ce;">),
    Text(String),
    Boolean(</span><span style="color:#b48ead;">bool</span><span style="color:#c0c5ce;">),
}
</span></code></pre>
<p>Changing <code>properties</code> from <code>HashMap&lt;String, Property&gt;</code> to <code>HashMap&lt;String, f64&gt;</code> would make it much easier to deal with property values, and it would pretty much cover every case except for <code>Text</code> which I probably don't even need.</p>
<p>In other news, I made my own struct for the turn queue that uses a HashSet to track duplicate entries.  Now it'll ignore any <code>push</code> that contains a value that's already in the queue.  Works like magic and everything is still lightning fast. Hooray!</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">pub struct </span><span style="color:#c0c5ce;">TurnQueue {
    </span><span style="color:#bf616a;">queue</span><span style="color:#c0c5ce;">: VecDeque&lt;</span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">&gt;,
    </span><span style="color:#bf616a;">element_set</span><span style="color:#c0c5ce;">: HashSet&lt;</span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">&gt;,
}
</span></code></pre>
<p><strong>Next up:</strong></p>
<p>Adding a ground layer.  This will be for stuff like plants that creatures can walk on top of without taking their space.  This feature is the main reason I'm so concerned about performance since it's going to double the size of my grid.  It should be cool though.  It'll behave just like the existing layer so I'll basically have two simulations going at once.  One to determine the landscape and one to determine the action that happens on top of that landscape.</p>
<p>Here's a pretty picture.</p>
<p><img src="https://picklenerd.github.io/static/images/mlh3.gif" alt="pretty-picture" /></p>

                            </div>
                        </div>
                        
                        
<footer class="card-footer">
    <div class="article-footer">
        <div class="columns is-multiline">
            <div class="column is-12">
                <p>
                    Published
                    

<time datetime="2017-07-15">
    2017-07-15
</time>


                    


                    


                    

and tagged

<a href="https://picklenerd.github.io/tags/learning-rust/">
    <span class="tag is-link">learning-rust </span>
</a>




                </p>
            </div>
            <div class="column">
                <a class="button is-pulled-right is-info" href="/">Back Home</a>
            </div>
        </div>
    </div>
</footer>

                        
                    </div>
                </article>
            </div>
        </div>
    </section>
</main>

    
    

<footer class="footer js-only">
    <div class="columns">
        <div class="column">
            <div class="content is-flex">
                <div class="theme-select-container">
                    Theme:
                    <select id="theme-select">
                        
                        
                        
                        
                        
                        <option value="default">default</option>
                        
                        
                        
                        
                        
                        
                        <option selected="selected" value="darkly">darkly</option>
                        
                        
                        
                        
                        
                        
                        <option value="flatly">flatly</option>
                        
                        
                        
                        
                        
                        
                        <option value="pulse">pulse</option>
                        
                        
                        
                        
                        
                        
                        <option value="simplex">simplex</option>
                        
                        
                        
                        
                        
                        
                        <option value="lux">lux</option>
                        
                        
                        
                        
                        
                        
                        <option value="slate">slate</option>
                        
                        
                        
                        
                        
                        
                        <option value="solar">solar</option>
                        
                        
                        
                        
                        
                        
                        <option value="superhero">superhero</option>
                        
                        
                    </select>
                </div>
            </div>
        </div>
    </div>
</footer>


    

    <script type="text/javascript" src="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;js&#x2F;zulma_navbar.js"></script>

    
    <script type="text/javascript" src="https:&#x2F;&#x2F;picklenerd.github.io&#x2F;js&#x2F;zulma_search.js"></script>
    

    
</body>

</html>